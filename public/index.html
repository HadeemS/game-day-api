<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Day Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script>
    // Auto-detect if on GitHub Pages and use Render API, otherwise use relative paths for local dev
    if(window.location.hostname.includes('github.io') || window.location.hostname.includes('github.com')){
      window.__GAME_DAY_API_BASE__ = "https://game-day-api-1.onrender.com";
    }
  </script>

  <!-- If you ALSO host this page on GitHub Pages, uncomment the line below so it fetches the Render API -->
  <style>
    /* tiny helpers to avoid relying on external CSS if missing */
    body{margin:0;font-family:"Space Grotesk",system-ui,Arial;background:#0b0b0b;color:#f4f4f5}
    a{color:#7aa2ff;text-decoration:none} a:hover{text-decoration:underline}
    .shell{padding:24px;max-width:1200px;margin:0 auto}
    .hero{display:grid;gap:24px;grid-template-columns:1.2fr 1fr;margin-bottom:24px}
    .panel{background:#111827;border:1px solid #2f3846;border-radius:16px}
    .panel__header{padding:16px 16px 0}
    .preview-card{background:#111827;border:1px solid #2f3846;border-radius:16px;padding:12px;margin-bottom:12px}
    .routes-list{list-style:none;padding:0;margin:0}
    .routes-list li{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;margin:6px 0}
    .http-method{font-weight:700;background:#1f2937;border:1px solid #2f3846;padding:2px 6px;border-radius:8px}
    .content-grid{display:grid;grid-template-columns:1fr;gap:16px}
    .form-grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr));padding:16px}
    label{display:flex;flex-direction:column;gap:6px}
    .full{grid-column:1/-1}
    input,select,textarea{background:#0b0b0b;border:1px solid #2f3846;color:#f4f4f5;border-radius:10px;padding:10px}
    .form-footer{display:flex;align-items:center;gap:10px;justify-content:flex-end;padding:0 16px 16px}
    .status{margin:0;padding:8px 10px;border-radius:999px;font-size:.9rem}
    .ok{background:#064e3b;color:#d1fae5}
    .err{background:#7f1d1d;color:#fee2e2}
    .list-panel{padding:16px}
    .games-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{background:#0b0b0b;border:1px solid #2f3846;border-radius:16px;overflow:hidden}
    .card img{width:100%;height:160px;object-fit:cover;display:block}
    .badge{position:absolute;top:10px;left:10px;background:#111827;border:1px solid #2f3846;border-radius:999px;padding:4px 8px;font-size:.8rem}
    .card-body{padding:12px}
    .price{font-weight:700;color:#a7f3d0}
    .muted{opacity:.8}
    .alert{color:#fecaca}
    iframe{width:100%;height:260px;border:0;border-radius:12px;background:#0b0b0b}
    @media (max-width:980px){.hero{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="shell">
    <header class="hero">
      <div>
        <p class="muted">Game Day API &amp; Demo</p>
        <h1>Plan must-watch matchups and keep the hype flowing.</h1>
        <p class="muted">Try the API, post a new rivalry, and see it populate instantly.</p>

        <div style="margin:16px 0">
          <p class="muted">Main 242 Home Base</p>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <a class="panel" style="padding:10px;display:flex;justify-content:space-between" target="_blank" href="https://github.com/HadeemS/game-day-api"><span>Server - GitHub</span><span>→</span></a>
            <a class="panel" style="padding:10px;display:flex;justify-content:space-between" target="_blank" href="https://game-day-api.onrender.com"><span>Server - Render</span><span>→</span></a>
            <a class="panel" style="padding:10px;display:flex;justify-content:space-between" target="_blank" href="https://github.com/HadeemS/game-day"><span>Client - GitHub</span><span>→</span></a>
            <a class="panel" style="padding:10px;display:flex;justify-content:space-between" target="_blank" href="https://hadeems.github.io/game-day"><span>Client - Live Site</span><span>→</span></a>
          </div>
        </div>

        <div class="panel" style="padding:16px">
          <p class="muted">Routes</p>
          <ul class="routes-list">
            <li><span class="http-method">GET</span> <a id="link-all" href="/api/games" target="_blank">/api/games</a> <p>List all games</p></li>
            <li><span class="http-method">GET</span> <a id="link-one" href="/api/games/1" target="_blank">/api/games/:id</a> <p>Single game</p></li>
            <li><span class="http-method">POST</span> <a id="link-post" href="/api/games" target="_blank">/api/games</a> <p>Add a new matchup (use form below)</p></li>
          </ul>
        </div>
      </div>

      <div>
        <div class="preview-card">
          <p class="muted">Live JSON Preview (iframe)</p>
          <iframe id="json-frame" title="Game Day API response" src="/api/games" loading="lazy"></iframe>
        </div>
        <div class="preview-card">
          <p class="muted">Live JSON (pretty)</p>
          <pre id="json-pretty" style="white-space:pre-wrap;background:#111;color:#0f0;padding:12px;border-radius:12px;min-height:200px;overflow:auto;">Loading…</pre>
          <button id="refresh" style="margin-top:8px;border:none;border-radius:10px;padding:8px 12px;background:#111;color:#fff;cursor:pointer">Refresh JSON</button>
        </div>
      </div>
    </header>

    <section class="content-grid">
      <section class="panel">
        <div class="panel__header">
          <h2>Post a marquee matchup</h2>
          <p class="muted">Client-side checks mirror your server rules.</p>
        </div>
        <form id="add-form" class="form-grid" novalidate>
          <label>Matchup Title<input name="title" placeholder="Lakers vs Celtics" required /></label>
          <label>League
            <select name="league">
              <option>NBA</option><option>NFL</option><option>NCAA Football</option><option>MLB</option><option>MLS</option>
            </select>
          </label>
          <label>Date<input type="date" name="date" required /></label>
          <label>Time<input type="time" name="time" required /></label>
          <label>Venue<input name="venue" placeholder="Crypto.com Arena" required /></label>
          <label>City<input name="city" placeholder="Los Angeles, CA" required /></label>
          <label>Starting Price (USD)<input type="number" name="price" min="0" step="1" value="0" required /></label>
          <label class="full">Image path<input name="img" placeholder="/images/usc-vs-clemson.jpg" required /></label>
          <label class="full">Image URL<input name="imageUrl" placeholder="/images/usc-vs-clemson.jpg or https://example.com/image.jpg" required /></label>
          <label class="full">Summary<textarea rows="3" name="summary" placeholder="What makes this matchup must-see TV?" required></textarea></label>
          <div class="form-footer">
            <span id="status" class="status" style="display:none"></span>
            <button type="submit">Share this game</button>
          </div>
        </form>
      </section>

      <section class="panel list-panel">
        <div class="panel__header">
          <h2>Upcoming spotlight games</h2>
          <p class="muted">Every time you post, the schedule updates instantly.</p>
        </div>
        <div id="list" class="games-grid"></div>
        <p id="list-error" class="alert" style="display:none"></p>
      </section>
    </section>
  </main>

  <script>
    const API_BASE = window.__GAME_DAY_API_BASE__ || window.location.origin;

    function $(sel){ return document.querySelector(sel); }
    function el(tag, props={}, children=[]){
      const n = document.createElement(tag);
      Object.entries(props).forEach(([k,v]) => {
        if (k === 'class') n.className = v;
        else if (k === 'text') n.textContent = v;
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(c));
      return n;
    }

    function fmtDate(s){
      if(!s) return "";
      const d = new Date(s + "T00:00:00");
      return isNaN(d) ? s : d.toLocaleDateString(undefined,{weekday:"short",month:"short",day:"numeric",year:"numeric"});
    }
    function fmtMoney(n){ return "$" + Number(n||0).toLocaleString("en-US"); }

    async function loadJSON(){
      try{
        const r = await fetch(API_BASE + "/api/games");
        const data = await r.json();
        $("#json-pretty").textContent = JSON.stringify(data, null, 2);
        renderList(data);
        // fix the iframe + links to use correct base
        $("#json-frame").src = API_BASE + "/api/games";
        $("#link-all").href = API_BASE + "/api/games";
        $("#link-post").href = API_BASE + "/api/games";
        $("#link-one").href = API_BASE + "/api/games/1";
      }catch(e){
        $("#json-pretty").textContent = "Failed to load JSON.";
        $("#list-error").style.display = "";
        $("#list-error").textContent = "Unable to load games.";
      }
    }

    function resolveImageUrl(game){
      const candidate = game.imageUrl || game.img || "";
      if (!candidate) return "";
      const lower = candidate.toLowerCase();
      if (lower.startsWith("http://") || lower.startsWith("https://")) {
        return candidate;
      }
      return API_BASE + candidate;
    }

    function renderList(items){
      const list = $("#list");
      list.innerHTML = "";
      items.sort((a,b)=> new Date(a.date+"T"+a.time) - new Date(b.date+"T"+b.time));
      items.forEach(g => {
        const card = el("article",{class:"card"},[
          (() => {
            const wrap = el("div",{style:"position:relative"});
            const imageSrc = resolveImageUrl(g);
            wrap.append(
              el("img",{src: imageSrc, alt: g.title, loading:"lazy"}),
              el("span",{class:"badge", text: g.league})
            );
            return wrap;
          })(),
          (() => {
            const body = el("div",{class:"card-body"});
            body.append(
              el("h3",{text:g.title}),
              el("p",{class:"muted", text: `${fmtDate(g.date)} at ${g.time}`}),
              el("p",{class:"muted", text: `${g.venue}, ${g.city}`}),
              el("p",{text:g.summary}),
              el("p",{class:"price", text: fmtMoney(g.price)})
            );
            return body;
          })()
        ]);
        list.appendChild(card);
      });
    }

    async function createGame(payload){
      try {
        const r = await fetch(API_BASE + "/api/games", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=>({error: "Failed to parse response"}));
        if(!r.ok){
          const msg = (data && (data.message || data.error)) || `Server error (${r.status})`;
          const extra = (data && data.details && data.details.join(" ")) || "";
          throw new Error(extra ? (msg + " " + extra) : msg);
        }
        return (data && (data.game || data.item)) || null;
      } catch(err) {
        // If it's a network error, provide more helpful message
        if(err.name === "TypeError" && err.message.includes("fetch")) {
          throw new Error(`Network error: Could not reach ${API_BASE}. Check if server is running.`);
        }
        throw err;
      }
    }

    function formStatus(type, msg){
      const box = $("#status");
      box.className = "status " + (type === "error" ? "err" : "ok");
      box.textContent = msg;
      box.style.display = "";
      setTimeout(() => { box.style.display = "none"; }, 3000);
    }

    // Client-side validation matching server-side Joi schema
    function validateGame(data){
      const errors = [];
      
      // title: string().min(3).max(80).required()
      if(!data.title || data.title.trim().length < 3 || data.title.trim().length > 80){
        errors.push("Title must be 3-80 characters");
      }
      
      // league: string().valid("NFL","NBA","NCAA Football","MLB","MLS").required()
      const validLeagues = ["NFL", "NBA", "NCAA Football", "MLB", "MLS"];
      if(!data.league || !validLeagues.includes(data.league)){
        errors.push("League must be one of: NFL, NBA, NCAA Football, MLB, MLS");
      }
      
      // date: string().pattern(/^\d{4}-\d{2}-\d{2}$/).required()
      if(!data.date || !/^\d{4}-\d{2}-\d{2}$/.test(data.date)){
        errors.push("Date must be in YYYY-MM-DD format");
      }
      
      // time: string().pattern(/^\d{2}:\d{2}$/).required()
      if(!data.time || !/^\d{2}:\d{2}$/.test(data.time)){
        errors.push("Time must be in HH:MM format");
      }
      
      // venue: string().min(2).max(80).required()
      if(!data.venue || data.venue.trim().length < 2 || data.venue.trim().length > 80){
        errors.push("Venue must be 2-80 characters");
      }
      
      // city: string().min(2).max(80).required()
      if(!data.city || data.city.trim().length < 2 || data.city.trim().length > 80){
        errors.push("City must be 2-80 characters");
      }
      
      // price: number().integer().min(0).max(10000).required()
      const priceNum = Number(data.price);
      if(isNaN(priceNum) || !Number.isInteger(priceNum) || priceNum < 0 || priceNum > 10000){
        errors.push("Price must be an integer between 0 and 10000");
      }
      
      // img: string().pattern(/^\/images\/[a-z0-9._\-]+\.(png|jpg|jpeg|webp)$/i).required()
      if(!data.img || !/^\/images\/[a-z0-9._\-]+\.(png|jpg|jpeg|webp)$/i.test(data.img.trim())){
        errors.push("Image must be a path like /images/filename.png (png, jpg, jpeg, or webp)");
      }
      
      // imageUrl: string().pattern(/^(https?:\/\/[^\s]+|\/[^\s]+\.(png|jpg|jpeg|webp|gif)$)/i).required()
      if(!data.imageUrl || !/^(https?:\/\/[^\s]+|\/[^\s]+\.(png|jpg|jpeg|webp|gif)$)/i.test(data.imageUrl.trim())){
        errors.push("Image URL must be a full URL (http:// or https://) or a relative path ending with .png, .jpg, .jpeg, .webp, or .gif");
      }
      
      // summary: string().min(5).max(240).required()
      if(!data.summary || data.summary.trim().length < 5 || data.summary.trim().length > 240){
        errors.push("Summary must be 5-240 characters");
      }
      
      return errors.length > 0 ? errors : null;
    }

    $("#refresh").addEventListener("click", loadJSON);

    $("#add-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const payload = {
        title: fd.get("title")?.trim() || "",
        league: fd.get("league") || "NBA",
        date: fd.get("date") || "",
        time: fd.get("time") || "", // HTML5 time input returns HH:MM format
        venue: fd.get("venue")?.trim() || "",
        city: fd.get("city")?.trim() || "",
        price: Math.floor(Number(fd.get("price") || 0)), // Ensure integer
        img: (fd.get("img") || "").trim(),
        imageUrl: (fd.get("imageUrl") || "").trim(),
        summary: fd.get("summary")?.trim() || ""
      };
      
      // Client-side validation
      const validationErrors = validateGame(payload);
      if(validationErrors){
        formStatus("error", validationErrors.join(". "));
          return;
        }

      try{
        const created = await createGame(payload);
        formStatus("ok","Game posted successfully!");
        await loadJSON(); // refresh list + pretty JSON
        // reset some fields
        e.currentTarget.reset();
      }catch(err){
        formStatus("error", err.message);
      }
    });

    // initial load
    loadJSON();
  </script>
</body>
</html>
