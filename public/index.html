<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Day Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- If you also host this same file on GitHub Pages, this line makes it call the Render API -->
  <!-- <script>window.__GAME_DAY_API_BASE__="https://game-day-api.onrender.com";</script> -->

  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const API_BASE = window.__GAME_DAY_API_BASE__ || window.location.origin;

    const PROJECT_LINKS = [
      { label: "Server - GitHub", href: "https://github.com/HadeemS/game-day-api" },
      { label: "Server - Render", href: "https://game-day-api.onrender.com" },
      { label: "Client - GitHub", href: "https://github.com/HadeemS/game-day" },
      { label: "Client - Live Site", href: "https://hadeems.github.io/game-day" }
    ];

    const DATE_REGEX = /^\d{4}-\d{2}-\d{2}$/;
    const TIME_REGEX = /^([01]\d|2[0-3]):[0-5]\d$/;
    const IMG_REGEX  = /^(https?:\/\/|\/)/i;

    const initialFormState = { title:"", league:"", date:"", time:"", venue:"", city:"", price:"", img:"", summary:"" };

    const validateGame = (v) => {
      const e = {};
      if (!v.title.trim()) e.title = "Matchup title is required.";
      else if (v.title.trim().length < 3) e.title = "Title should be at least 3 characters.";
      if (!v.league.trim()) e.league = "League is required.";
      if (!v.date) e.date = "Date is required.";
      else if (!DATE_REGEX.test(v.date)) e.date = "Use YYYY-MM-DD format.";
      if (!v.time) e.time = "Kick/tip time is required.";
      else if (!TIME_REGEX.test(v.time)) e.time = "Use 24-hour HH:mm format.";
      if (!v.venue.trim()) e.venue = "Venue is required.";
      if (!v.city.trim()) e.city  = "City is required.";
      if (v.price === "") e.price = "Price is required.";
      else if (Number.isNaN(Number(v.price))) e.price = "Price must be a number.";
      else if (Number(v.price) < 0) e.price = "Price cannot be negative.";
      else if (Number(v.price) > 10000) e.price = "Price must be $10,000 or less.";
      if (!v.img.trim()) e.img = "Image path or URL is required.";
      else if (!IMG_REGEX.test(v.img.trim())) e.img = "Image should start with http(s):// or /";
      if (!v.summary.trim()) e.summary = "Summary is required.";
      else if (v.summary.trim().length < 10) e.summary = "Summary must be at least 10 characters.";
      else if (v.summary.trim().length > 240) e.summary = "Summary must be under 240 characters.";
      return e;
    };

    const formatCurrency = n => `$${Number(n || 0).toLocaleString("en-US")}`;
    const formatDate = s => {
      if (!s) return "";
      const d = new Date(`${s}T00:00:00`);
      return Number.isNaN(d.getTime()) ? s : d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric", year:"numeric" });
    };

    async function loadPrettyJSON(){
      try {
        const res = await fetch(`${API_BASE}/api/games`);
        const data = await res.json();
        document.getElementById("json-pretty").textContent = JSON.stringify(data, null, 2);
      } catch {
        document.getElementById("json-pretty").textContent = "Failed to load JSON.";
      }
    }

    const GameCard = ({ game }) => (
      <article className="game-card">
        <div className="game-card__media">
          <img src={game.img} alt={game.title} loading="lazy" />
          <span className="game-card__badge">{game.league}</span>
        </div>
        <div className="game-card__body">
          <h3>{game.title}</h3>
          <p className="game-card__datetime">{formatDate(game.date)} at {game.time}</p>
          <p className="game-card__location">{game.venue}, {game.city}</p>
          <p className="game-card__summary">{game.summary}</p>
          <p className="game-card__price">{formatCurrency(game.price)}</p>
        </div>
      </article>
    );

    const App = () => {
      const [games, setGames] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [fetchError, setFetchError] = React.useState("");
      const [formData, setFormData] = React.useState(initialFormState);
      const [formErrors, setFormErrors] = React.useState({});
      const [status, setStatus] = React.useState({ type:"idle", message:"" });
      const [submitting, setSubmitting] = React.useState(false);

      const fetchGames = React.useCallback(async () => {
        setLoading(true); setFetchError("");
        try {
          const r = await fetch(`${API_BASE}/api/games`);
          if(!r.ok) throw new Error("Unable to load games.");
          setGames(await r.json());
        } catch (e) {
          setFetchError(e.message || "Unable to load games.");
        } finally { setLoading(false); }
      }, []);

      React.useEffect(() => {
        fetchGames();
        loadPrettyJSON();
        const btn = document.getElementById("refresh-json");
        if (btn) btn.addEventListener("click", loadPrettyJSON);
      }, [fetchGames]);

      const sortedGames = React.useMemo(() => {
        return [...games].sort((a,b) =>
          new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`)
        );
      }, [games]);

      const handleChange = e => {
        const { name, value } = e.target;
        setFormData(f => ({ ...f, [name]: value }));
        setFormErrors(f => ({ ...f, [name]: undefined }));
        setStatus({ type:"idle", message:"" });
      };

      const handleSubmit = async e => {
        e.preventDefault();
        const errors = validateGame(formData);
        if (Object.keys(errors).length){
          setFormErrors(errors);
          setStatus({ type:"error", message:"Please fix the highlighted fields." });
          return;
        }

        setSubmitting(true);
        try {
          const payload = { ...formData, price: Number(formData.price) };
          const r = await fetch(`${API_BASE}/api/games`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          const data = await r.json().catch(()=>null);
          if (!r.ok) {
            const msg = data?.message || data?.error || "Unable to save game.";
            const extra = data?.details?.join(" ") || "";
            throw new Error(extra ? `${msg} ${extra}` : msg);
          }
          const created = data?.game || data?.item;
          if (created) setGames(cur => [...cur, created]); else await fetchGames();
          setFormData(initialFormState);
          setFormErrors({});
          setStatus({ type:"success", message:"Game posted successfully!" });
          loadPrettyJSON();
        } catch (err) {
          setStatus({ type:"error", message: err.message || "Unable to save game." });
        } finally { setSubmitting(false); }
      };

      return (
        <main className="shell">
          <header className="hero">
            <div className="hero__copy">
              <p className="eyebrow">Game Day API & React Client</p>
              <h1>Plan must-watch matchups and keep the hype flowing.</h1>
              <p className="lede">Try the API, post a new rivalry, and see it populate instantly.</p>

              <div className="project-links">
                <p className="section-label">Main 242 Home Base</p>
                <div className="links-grid">
                  {PROJECT_LINKS.map(l => (
                    <a key={l.label} href={l.href} target="_blank" rel="noreferrer" className="link-tile">
                      <span>{l.label}</span><span aria-hidden="true">â†’</span>
                    </a>
                  ))}
                </div>
              </div>

              <div className="routes-wrap">
                <p className="section-label">Routes</p>
                <ul className="routes-list">
                  <li><span className="http-method">GET</span><a href="/api/games" target="_blank">/api/games</a><p>List all posted games</p></li>
                  <li><span className="http-method">GET</span><a href="/api/games/1" target="_blank">/api/games/:id</a><p>Grab a single contest</p></li>
                  <li><span className="http-method">POST</span><code>/api/games</code><p>Add a brand new matchup</p></li>
                </ul>
              </div>
            </div>

            <div className="hero__preview">
              <div className="preview-card">
                <p className="section-label">Live JSON Preview (iframe)</p>
                <iframe title="Game Day API response" src="/api/games" loading="lazy"></iframe>
              </div>
              <div className="preview-card">
                <p className="section-label">Live JSON (pretty)</p>
                <pre id="json-pretty" style="white-space:pre-wrap;background:#111;color:#0f0;padding:12px;border-radius:12px;min-height:200px;overflow:auto;"></pre>
                <button id="refresh-json" style="margin-top:8px;border:none;border-radius:10px;padding:8px 12px;background:#111;color:#fff;cursor:pointer">Refresh JSON</button>
              </div>
            </div>
          </header>

          <section className="content-grid">
            <section className="panel form-panel">
              <div className="panel__header">
                <h2>Post a marquee matchup</h2>
                <p>Client-side validation mirrors the server rules.</p>
              </div>
              <form className="form-grid" onSubmit={handleSubmit} noValidate>
                <label><span>Matchup Title</span><input name="title" placeholder="Lakers vs Celtics" value={formData.title} onChange={handleChange} aria-invalid={!!formErrors.title}/>{formErrors.title && <span className="field-error">{formErrors.title}</span>}</label>
                <label><span>League</span><input name="league" placeholder="NBA, NFL, NCAA Football..." value={formData.league} onChange={handleChange} aria-invalid={!!formErrors.league}/>{formErrors.league && <span className="field-error">{formErrors.league}</span>}</label>
                <label><span>Date</span><input type="date" name="date" value={formData.date} onChange={handleChange} aria-invalid={!!formErrors.date}/>{formErrors.date && <span className="field-error">{formErrors.date}</span>}</label>
                <label><span>Time</span><input type="time" name="time" value={formData.time} onChange={handleChange} aria-invalid={!!formErrors.time}/>{formErrors.time && <span className="field-error">{formErrors.time}</span>}</label>
                <label><span>Venue</span><input name="venue" placeholder="Crypto.com Arena" value={formData.venue} onChange={handleChange} aria-invalid={!!formErrors.venue}/>{formErrors.venue && <span className="field-error">{formErrors.venue}</span>}</label>
                <label><span>City</span><input name="city" placeholder="Los Angeles, CA" value={formData.city} onChange={handleChange} aria-invalid={!!formErrors.city}/>{formErrors.city && <span className="field-error">{formErrors.city}</span>}</label>
                <label><span>Starting Price (USD)</span><input type="number" name="price" placeholder="120" value={formData.price} onChange={handleChange} aria-invalid={!!formErrors.price}/>{formErrors.price && <span className="field-error">{formErrors.price}</span>}</label>
                <label className="field--full"><span>Image URL or Path</span><input name="img" placeholder="/images/lakers-vs-celtics.png" value={formData.img} onChange={handleChange} aria-invalid={!!formErrors.img}/>{formErrors.img && <span className="field-error">{formErrors.img}</span>}</label>
                <label className="field--full"><span>Summary</span><textarea rows="3" name="summary" placeholder="What makes this matchup must-see TV?" value={formData.summary} onChange={handleChange} aria-invalid={!!formErrors.summary}></textarea>{formErrors.summary && <span className="field-error">{formErrors.summary}</span>}</label>

                <div className="form-footer">
                  {status.message && <p className={`status-pill ${status.type === "error" ? "status-pill--error" : "status-pill--success"}`}>{status.message}</p>}
                  <button type="submit" disabled={submitting}>{submitting ? "Posting..." : "Share this game"}</button>
                </div>
              </form>
            </section>

            <section className="panel list-panel">
              <div className="panel__header">
                <h2>Upcoming spotlight games</h2>
                <p>Every time you post, the schedule updates instantly.</p>
              </div>
              {loading && <p className="muted">Loading your slate...</p>}
              {fetchError && !loading && <p className="alert alert--error">{fetchError}</p>}
              {!loading && !fetchError && (
                sortedGames.length === 0
                ? <p className="muted">No games yet. Be the first to add one!</p>
                : <div className="games-grid">{sortedGames.map(g => <GameCard game={g} key={g._id} />)}</div>
              )}
            </section>
          </section>
        </main>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
